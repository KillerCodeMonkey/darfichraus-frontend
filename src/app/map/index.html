<!DOCTYPE HTML>
<html lang="de">
  <head>
    <meta charset="utf-8"/>
    <title>Eine OSM Karte mit Leaflet</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" />
    <link rel="stylesheet" href="osm_styles.css" />
    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"></script>
    <script type="text/javascript" src="res/bundeslaender_simplify200.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
    <script src="globe/Control.GlobeMiniMap.js"></script>
    <!--script type="text/javascript" src="globe/world.js"></script-->
    <link rel="stylesheet" href="pulse/L.Icon.Pulse.css" />
    <script src="pulse/L.Icon.Pulse.js"></script>
    <link href="http://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
  </head>
  <body>
    <p>Bitte geben Sie eine Koordinate an:</p><br>
    Geographische Breite:<input type="text" id="lat"><br>
    Geographische Länge:<input type="text" id="long"><br>
    Name:<input type="text" id="name"><br>
    <button onclick="save()">Speichern</button>
    <div><br/></div>
    <div style="height: 700px;" id="mapid"></div>
    <script>
      //example values for states
      var stateCriticality = [1, 20000, 212, 495, 1230, 3322, 8902, 10020, 12555, 222, 12, 0, 1234, 1234, 1234, 1244];
      var stateAllowedToGoOut = [true, true, false, false, false, false, false, true, false, false, false, false, true, false, false, false];
      var selectedFeature;
      var coronamap = L.map('mapid', {zoomControl: false}).setView([51.27264, 9.26469], 6);
      //Colored Map
      //var layer = L.tileLayer('https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=nTu7VeaqY0M6ygrBHNTx').addTo(coronamap);

      //Greyscale Map
      var mbAttr = 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
      			'<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
      			'Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
      		mbUrl = 'https://api.mapbox.com/styles/v1/{id}/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

      var layer = L.tileLayer(mbUrl, {id: 'mapbox/light-v9', tileSize: 512, zoomOffset: -1, attribution: mbAttr, maxZoom: 8, minZoom: 6});

      function setOutlinedHighlightedPolygon(layer){
        layer.setStyle({
          weight: 2,
          color: '#8B0000',
          dashArray: '',
          fillOpacity: 0.7
        });
      }

      function setFilledHighlightedPolygon(layer){
        layer.setStyle({
          weight: 2,
          color: '#8B0000',
          dashArray: '',
          fillOpacity: 5
        });
      }

      // INFO
      var info = L.control();
      info.onAdd = function (coronamap) {
          this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
          this.update();
          return this._div;
      };

      // method that we will use to update the control based on feature properties passed
      info.update = function (props) {
          this._div.innerHTML = '<h4>Corona Ausgangssperre</h4>' +  (props ?
              '<b>'+ props.GEN+ '</b><br />'
              + stateCriticality[Math.floor(Math.random()*15)] + ' Menschen infiziert <br />'
              +'<br /> <b>Bevölkerung:</b> ' + props.destatis.population
              +'<br /><br /> <b>Ausgangssperre: <br /></b>21.03.2020 - 15.04.2020'
              : 'Ein Bundesland auswählen');
      };

      info.addTo(coronamap);

      //geoJSON german states
      // get color depending on population density value
      	function getColor(d) {
      		return d > 20000 ? '#800026' :
      				d > 10000  ? '#BD0026' :
      				d > 5000  ? '#E31A1C' :
      				d > 1000  ? '#FC4E2A' :
      				d > 50   ? '#FD8D3C' :
      				d > 20   ? '#FEB24C' :
      				d > 10   ? '#FED976' :
      							'#FFEDA0';
      	}

      	function style(feature) {
          //if ausgangssperre different border style?
          if(stateAllowedToGoOut[parseInt(feature.properties.RS, 10)]){
        		return {
        			weight: 1.5,
        			opacity: 1,
        			color: 'white',
        			dashArray: '1',
        			fillOpacity: 0.6,
              fillColor: getColor(stateCriticality[parseInt(feature.properties.RS, 10)])
        		};
          }else{
            return {
              weight: 1,
              opacity: 1,
              color: 'white',
              dashArray: '3',
              fillOpacity: 0.7,
              fillColor: getColor(stateCriticality[parseInt(feature.properties.RS, 10)])
            };
          }
      	}

      	function highlightFeature(e) {
      		var layer = e.target;
          var zoomlevel = coronamap.getZoom();

          if(zoomlevel<=6 || e.target != selectedFeature){
            setOutlinedHighlightedPolygon(layer);

          }else {
            setFilledHighlightedPolygon(layer);
            console.log(layer.getBounds().getCenter);
            //var label = new L.Label()
            //label.setContent("static label")
            //label.setLatLng(layer.getBounds().getCenter())
            coronamap.showLabel(label);
          }

          if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
            layer.bringToFront();
          }
      		info.update(layer.feature.properties);
      	}

      	var geojson;
      	function resetHighlight(e) {
          var layer = e.target;
          var zoomlevel = coronamap.getZoom();
          if(zoomlevel<=6 || e.target != selectedFeature){
      		  geojson.resetStyle(e.target);
          } else {
              setFilledHighlightedPolygon(layer);
          }
          info.update();
      	}

        geojson = L.geoJson(statesData, {
      		style: style,
      		onEachFeature: onEachFeature
      	}).addTo(coronamap);

      	function zoomToFeature(e) {
          coronamap.resetStyle;
          if(selectedFeature!=null){
            setOutlinedHighlightedPolygon(selectedFeature);
          }
      		coronamap.fitBounds(e.target.getBounds());
          selectedFeature = e.target;

          setFilledHighlightedPolygon(e.target);
      	}

      	function onEachFeature(feature, layer) {
      		layer.on({
      			mouseover: highlightFeature,
      			mouseout: resetHighlight,
      			click: zoomToFeature
      		});
      	}

      	var legend = L.control({position: 'bottomright'});

      	legend.onAdd = function (coronamap) {
      		var div = L.DomUtil.create('div', 'info legend'),
      			grades = [0, 10, 20, 50, 1000, 5000, 10000, 20000],
      			labels = [],
      			from, to;

      		for (var i = 0; i < grades.length; i++) {
      			from = grades[i];
      			to = grades[i + 1];

      			labels.push(
      				'<i style="background:' + getColor(from + 1) + '"></i> ' +
      				from + (to ? '&ndash;' + to : '+'));
      		}

      		div.innerHTML = labels.join('<br>');
      		return div;
      	};

      	legend.addTo(coronamap);

        //Save marker
        function save()
        {
          var p1 = parseFloat(document.getElementById("lat").value);
          var p2 = parseFloat(document.getElementById("long").value);
          L.marker([p1,p2]).bindPopup(document.getElementById("name").value).addTo(coronamap);
        }

        //Pulse marker
        var pulsingIconSouth = L.icon.pulse({iconSize:[10,10],color:'red'});
        var markerSouth = L.marker([50,10],{icon: pulsingIconSouth}).addTo(coronamap);

        var pulsingIconNorth = L.icon.pulse({iconSize:[10,10],color:'red'});
        var markerNorth = L.marker([53,12],{icon: pulsingIconNorth}).addTo(coronamap);


        //Search control
        //TBD

        //GlobeMiniMap
        coronamap.addLayer(layer);

        var miniMap = new L.Control.GlobeMiniMap({
          //uncomment to assign colors
           //land:'#FFFF00',
           //water:'#3333FF',
           //marker:'#000000'
        }).addTo(coronamap);

        //Custom Zoom Control
        L.Control.zoomHome = L.Control.extend({
            options: {
                position: 'topleft',
                zoomInText: '+',
                zoomInTitle: 'Zoom in',
                zoomOutText: '-',
                zoomOutTitle: 'Zoom out',
                zoomHomeText: '<i class="fa fa-home" style="line-height:1.65;"></i>',
                zoomHomeTitle: 'Zoom home'
            },

            onAdd: function (map) {
                var controlName = 'gin-control-zoom',
                    container = L.DomUtil.create('div', controlName + ' leaflet-bar'),
                    options = this.options;

                this._zoomInButton = this._createButton(options.zoomInText, options.zoomInTitle,
                controlName + '-in', container, this._zoomIn);
                this._zoomHomeButton = this._createButton(options.zoomHomeText, options.zoomHomeTitle,
                controlName + '-home', container, this._zoomHome);
                this._zoomOutButton = this._createButton(options.zoomOutText, options.zoomOutTitle,
                controlName + '-out', container, this._zoomOut);

                this._updateDisabled();
                map.on('zoomend zoomlevelschange', this._updateDisabled, this);

                return container;
            },

            onRemove: function (map) {
                map.off('zoomend zoomlevelschange', this._updateDisabled, this);
            },

            _zoomIn: function (e) {
                this._map.zoomIn(e.shiftKey ? 3 : 1);
            },

            _zoomOut: function (e) {
                this._map.zoomOut(e.shiftKey ? 3 : 1);
            },

            _zoomHome: function (e) {
                coronamap.setView([51.27264, 9.26469], 6);
            },

            _createButton: function (html, title, className, container, fn) {
                var link = L.DomUtil.create('a', className, container);
                link.innerHTML = html;
                link.href = '#';
                link.title = title;

                L.DomEvent.on(link, 'mousedown dblclick', L.DomEvent.stopPropagation)
                    .on(link, 'click', L.DomEvent.stop)
                    .on(link, 'click', fn, this)
                    .on(link, 'click', this._refocusOnMap, this);

                return link;
            },

            _updateDisabled: function () {
                var map = this._map,
                    className = 'leaflet-disabled';

                L.DomUtil.removeClass(this._zoomInButton, className);
                L.DomUtil.removeClass(this._zoomOutButton, className);

                if (map._zoom === map.getMinZoom()) {
                    L.DomUtil.addClass(this._zoomOutButton, className);
                }
                if (map._zoom === map.getMaxZoom()) {
                    L.DomUtil.addClass(this._zoomInButton, className);
                }
            }
        });

        // add the new control to the map
        var zoomHome = new L.Control.zoomHome();
        zoomHome.addTo(coronamap);

    </script>
  </body>
</html>
